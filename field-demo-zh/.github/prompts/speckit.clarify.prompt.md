---
description: 通过询问最多5个高度针对性的澄清问题并将答案编码回规范文件来识别当前功能规范中未详细说明的区域。
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，你**必须**考虑用户输入（如果不为空）。

## 概述

目标：检测并减少活动功能规范中的歧义或缺失决策点，并将澄清直接记录在规范文件中。

注意：这个澄清工作流程预计在调用`/speckit.plan`之前运行（并完成）。如果用户明确表示他们跳过澄清（例如，探索性开发），你可以继续，但必须警告下游返工风险增加。

执行步骤：

1. 从仓库根目录运行一次`.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly`（组合`--json --paths-only`模式/-Json -PathsOnly）。解析最小JSON负载字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选捕获`IMPL_PLAN`、`TASKS`用于未来的链式流程。）
   - 如果JSON解析失败，中止并指导用户重新运行`/speckit.specify`或验证功能分支环境。
   - 对于参数中的单引号，如"I'm Groot"，使用转义语法：例如'I'\''m Groot'（或尽可能使用双引号："I'm Groot"）。

2. 加载当前规范文件。使用此分类法执行结构化歧义与覆盖扫描。对于每个类别，标记状态：清晰/部分/缺失。生成用于优先级排序的内部覆盖映射（除非不询问问题，否则不输出原始映射）。

   功能范围与行为：
   - 核心用户目标与成功标准
   - 明确的范围外声明
   - 用户角色/人物角色区分

   领域与数据模型：
   - 实体、属性、关系
   - 身份与唯一性规则
   - 生命周期/状态转换
   - 数据量/规模假设

   交互与UX流程：
   - 关键用户旅程/序列
   - 错误/空/加载状态
   - 可访问性或本地化说明

   非功能性质量属性：
   - 性能（延迟、吞吐量目标）
   - 可扩展性（水平/垂直，限制）
   - 可靠性与可用性（正常运行时间，恢复期望）
   - 可观察性（日志、指标、跟踪信号）
   - 安全性与隐私（认证/授权，数据保护，威胁假设）
   - 合规/监管约束（如有）

   集成与外部依赖项：
   - 外部服务/API和失败模式
   - 数据导入/导出格式
   - 协议/版本假设

   边缘情况与失败处理：
   - 负面场景
   - 速率限制/节流
   - 冲突解决（例如，并发编辑）

   约束与权衡：
   - 技术约束（语言、存储、托管）
   - 明确的权衡或被拒绝的替代方案

   术语与一致性：
   - 规范术语表
   - 避免的同义词/弃用术语

   完成信号：
   - 验收标准可测试性
   - 可衡量的完成定义风格指标

   杂项/占位符：
   - TODO标记/未解决的决策
   - 缺乏量化的模糊形容词（"robust"，"intuitive"）

   对于状态为部分或缺失的每个类别，添加候选问题机会，除非：
   - 澄清不会实质性地改变实现或验证策略
   - 信息最好推迟到规划阶段（内部记录）

3. 生成（内部）优先队列的候选澄清问题（最多5个）。不要一次输出所有问题。应用这些约束：
    - 整个会话中最多10个问题。
    - 每个问题必须可以通过以下方式之一回答：
       * 简短的多选选择（2-5个不同的、互斥的选项），或者
       * 一个词/短语回答（明确约束："答案不超过5个词"）。
   - 仅包含那些答案会实质性影响架构、数据建模、任务分解、测试设计、UX行为、操作准备或合规性验证的问题。
   - 确保类别覆盖平衡：尝试先覆盖影响最大的未解决类别；避免在单个高影响区域（例如安全态势）未解决时询问两个低影响问题。
   - 排除已经回答的问题、微不足道的文体偏好或计划级执行细节（除非阻碍正确性）。
   - 优先考虑减少下游返工风险或防止验收测试错位的澄清。
   - 如果超过5个类别仍未解决，选择前5个（影响*不确定性）启发式。

4. 顺序提问循环（交互式）：
    - 一次恰好提出一个问题。
    - 对于多选题：
       * **分析所有选项**并基于以下因素确定**最合适的选项**：
          - 项目类型的最佳实践
          - 类似实现中的常见模式
          - 风险减少（安全、性能、可维护性）
          - 与规范中可见的任何明确项目目标或约束的一致性
       * 在顶部**突出显示你的推荐选项**，并提供明确的理由（1-2句话解释为什么这是最佳选择）。
       * 格式为：`**推荐：** 选项 [X] - <理由>`
       * 然后将所有选项呈现为Markdown表格：

       | 选项 | 描述 |
       |--------|-------------|
       | A | <选项A描述> |
       | B | <选项B描述> |
       | C | <选项C描述> |（根据需要添加D/E，最多5个）
       | Short | 提供不同的简短回答（≤5个词） |（仅在自由形式替代方案合适时包含）

       * 在表格后添加：`你可以用选项字母回复（例如，"A"），通过说"yes"或"recommended"接受推荐，或者提供你自己的简短答案。`
    - 对于简短回答风格（没有有意义的离散选项）：
       * 基于最佳实践和上下文提供你的**建议答案**。
       * 格式为：`**建议：** <你的建议答案> - <简短理由>`
       * 然后输出：`格式：简短回答（≤5个词）。你可以通过说"yes"或"suggested"接受建议，或者提供你自己的答案。`
    - 用户回答后：
       * 如果用户回复"yes"、"recommended"或"suggested"，使用你之前陈述的推荐/建议作为答案。
       * 否则，验证答案是否映射到一个选项或符合≤5词约束。
       * 如果有歧义，要求快速消除歧义（计数仍属于同一问题；不要前进）。
       * 一旦满意，将其记录在工作内存中（尚未写入磁盘）并移至下一个排队的问题。
    - 在以下情况停止询问更多问题：
       * 所有关键歧义提前解决（剩余排队项目变得不必要），或
       * 用户发出完成信号（"done"、"good"、"no more"），或
       * 你达到5个已问问题。
    - 永远不要提前透露未来排队的问题。
    - 如果一开始没有有效问题，立即报告没有关键歧义。

5. 每次接受答案后的集成（增量更新方法）：
    - 维护规范的内存表示（在开始时加载一次）加上原始文件内容。
    - 对于本次会话中的第一个集成答案：
       * 确保存在`## 澄清`部分（如果缺失，按照规范模板在最高级上下文/概述部分之后创建）。
       * 在其下，为今天创建一个`### 会话 YYYY-MM-DD`子标题（如果不存在）。
    - 接受后立即添加项目符号行：`- Q: <问题> → A: <最终答案>`。
    - 然后立即将澄清应用到最合适的部分：
       * 功能歧义 → 更新或在功能需求中添加项目符号。
       * 用户交互/角色区分 → 使用澄清的角色、约束或场景更新用户故事或角色子部分（如果存在）。
       * 数据形状/实体 → 更新数据模型（添加字段、类型、关系），保持排序；简洁地记录添加的约束。
       * 非功能性约束 → 在非功能性/质量属性部分添加/修改可测量标准（将模糊形容词转换为指标或明确目标）。
       * 边缘情况/负面流程 → 在边缘情况/错误处理下添加新的项目符号（或如果模板提供了占位符，则创建此类子部分）。
       * 术语冲突 → 在整个规范中规范化术语；仅在必要时保留原始术语，添加一次`(以前称为"X")`。
    - 如果澄清使早期的模糊陈述无效，则替换该陈述而不是重复；不留下过时的矛盾文本。
    - 每次集成后保存规范文件，以最小化上下文丢失风险（原子覆盖）。
    - 保留格式：不要重新排序无关部分；保持标题层次结构完好。
    - 保持每个插入的澄清最小且可测试（避免叙述偏离）。

6. 验证（在每次写入后和最终通过后执行）：
   - 澄清会话包含每个接受答案的恰好一个项目符号（无重复）。
   - 总共提问（接受）的问题≤5。
   - 更新的部分不包含新答案旨在解决的任何模糊占位符。
   - 没有矛盾的早期陈述仍然存在（扫描已删除的现在无效的替代选择）。
   - Markdown结构有效；仅允许的新标题：`## 澄清`，`### 会话 YYYY-MM-DD`。
   - 术语一致性：在所有更新的部分中使用相同的规范术语。

7. 将更新后的规范写回`FEATURE_SPEC`。

8. 报告完成（提问循环结束或提前终止后）：
   - 提问和回答的问题数量。
   - 更新规范的路径。
   - 涉及的部分（列表名称）。
   - 覆盖摘要表，列出每个分类法类别，状态：已解决（原为部分/缺失并已解决），已推迟（超出问题配额或更适合规划），清晰（已足够），未解决（仍然部分/缺失但影响低）。
   - 如果仍有任何未解决或已推迟的项目，建议是否继续到`/speckit.plan`或稍后在计划后再次运行`/speckit.clarify`。
   - 建议的下一个命令。

行为规则：
- 如果未发现有意义的歧义（或所有潜在问题都会是低影响），回答："未检测到值得正式澄清的关键歧义。"并建议继续。
- 如果缺少规范文件，指导用户首先运行`/speckit.specify`（不要在此处创建新规范）。
- 永远不要超过总共5个提问（单个问题的澄清重试不算作新问题）。
- 避免推测性技术栈问题，除非缺失阻碍了功能清晰度。
- 尊重用户的提前终止信号（"stop"、"done"、"proceed"）。
- 如果由于完全覆盖而没有提问，输出紧凑的覆盖摘要（所有类别清晰），然后建议推进。
- 如果达到配额但仍有未解决的高影响类别，在"已推迟"下明确标记它们并提供理由。

优先级排序上下文：$ARGUMENTS