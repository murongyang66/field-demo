---
description: 根据可用的设计工件生成可执行、按依赖顺序排列的任务清单tasks.md。
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，你**必须**考虑用户输入（如果不为空）。

## 概述

1. **设置**：从仓库根目录运行 `.specify/scripts/powershell/check-prerequisites.ps1 -Json` 并解析FEATURE_DIR和AVAILABLE_DOCS列表。所有路径必须是绝对路径。对于参数中的单引号，如 "I'm Groot"，使用转义语法：例如 'I'\''m Groot'（或尽可能使用双引号："I'm Groot"）。

2. **加载设计文档**：从FEATURE_DIR读取：
   - **必需**：plan.md（技术栈、库、结构），spec.md（带优先级的用户故事）
   - **可选**：data-model.md（实体），contracts/（API端点），research.md（决策），quickstart.md（测试场景）
   - 注意：并非所有项目都有所有文档。根据可用的文档生成任务。

3. **执行任务生成工作流**：
   - 加载plan.md并提取技术栈、库、项目结构
   - 加载spec.md并提取带优先级的用户故事（P1，P2，P3等）
   - 如果data-model.md存在：提取实体并映射到用户故事
   - 如果contracts/存在：将端点映射到用户故事
   - 如果research.md存在：提取设置任务的决策
   - 按用户故事组织生成的任务（见下方任务生成规则）
   - 生成显示用户故事完成顺序的依赖关系图
   - 为每个用户故事创建并行执行示例
   - 验证任务完整性（每个用户故事有所有必要的任务，可独立测试）

4. **生成tasks.md**：使用`.specify.specify/templates/tasks-template.md`作为结构，填充：
   - 从plan.md获取正确的功能名称
   - 第1阶段：设置任务（项目初始化）
   - 第2阶段：基础任务（所有用户故事的阻塞前提条件）
   - 第3阶段及以后：每个用户故事一个阶段（按spec.md中的优先级顺序）
   - 每个阶段包括：故事目标、独立测试标准、测试（如有请求）、实现任务
   - 最后阶段：完善和跨领域关注点
   - 所有任务必须遵循严格的检查表格式（见下方任务生成规则）
   - 每个任务的明确文件路径
   - 依赖关系部分，显示故事完成顺序
   - 每个故事的并行执行示例
   - 实施策略部分（先MVP，增量交付）

5. **报告**：输出生成的tasks.md路径和摘要：
   - 任务总数
   - 每个用户故事的任务数
   - 识别的并行机会
   - 每个故事的独立测试标准
   - 建议的MVP范围（通常只是用户故事1）
   - 格式验证：确认所有任务都遵循检查表格式（复选框、ID、标签、文件路径）

任务生成上下文：$ARGUMENTS

tasks.md应该可以立即执行 - 每个任务必须足够具体，以便LLM无需额外上下文即可完成。

## 任务生成规则

**关键**：任务必须按用户故事组织，以实现独立实施和测试。

**测试是可选的**：仅在功能规范中明确要求或用户请求TDD方法时才生成测试任务。

### 检查表格式（必需）

每个任务必须严格遵循以下格式：

```text
- [ ] [TaskID] [P?] [Story?] 描述与文件路径
```

**格式组件**：

1. **复选框**：始终以`- [ ]`（markdown复选框）开始
2. **任务ID**：执行顺序中的序列号（T001，T002，T003...）
3. **[P]标记**：仅当任务可并行化时包含（不同文件，不依赖于未完成的任务）
4. **[Story]标签**：仅适用于用户故事阶段任务
   - 格式：[US1]，[US2]，[US3]等（映射到spec.md中的用户故事）
   - 设置阶段：无故事标签
   - 基础阶段：无故事标签
   - 用户故事阶段：必须有故事标签
   - 完善阶段：无故事标签
5. **描述**：明确的操作和确切的文件路径

**示例**：

- ✅ 正确：`- [ ] T001 创建项目结构（根据实施计划）`
- ✅ 正确：`- [ ] T005 [P] 在src/middleware/auth.py中实现身份验证中间件`
- ✅ 正确：`- [ ] T012 [P] [US1] 在src/models/user.py中创建用户模型`
- ✅ 正确：`- [ ] T014 [US1] 在src/services/user_service.py中实现UserService`
- ❌ 错误：`- [ ] 创建用户模型`（缺少ID和故事标签）
- ❌ 错误：`T001 [US1] 创建模型`（缺少复选框）
- ❌ 错误：`- [ ] [US1] 创建用户模型`（缺少任务ID）
- ❌ 错误：`- [ ] T001 [US1] 创建模型`（缺少文件路径）

### 任务组织

1. **来自用户故事（spec.md）** - 主要组织方式：
   - 每个用户故事（P1，P2，P3...）有自己的阶段
   - 将所有相关组件映射到其故事：
     - 该故事所需的模型
     - 该故事所需的服务
     - 该故事所需的端点/UI
     - 如果需要测试：特定于该故事的测试
   - 标记故事依赖关系（大多数故事应该是独立的）
   
2. **来自契约**：
   - 将每个契约/端点映射到它服务的用户故事
   - 如果需要测试：每个契约→契约测试任务[P]在该故事阶段的实现之前
   
3. **来自数据模型**：
   - 将每个实体映射到需要它的用户故事
   - 如果实体服务于多个故事：放在最早的故事或设置阶段
   - 关系→在适当的故事阶段中的服务层任务
   
4. **来自设置/基础设施**：
   - 共享基础设施→设置阶段（阶段1）
   - 基础/阻塞任务→基础阶段（阶段2）
   - 故事特定设置→在该故事的阶段内

### 阶段结构

- **阶段1**：设置（项目初始化）
- **阶段2**：基础（阻塞前提条件 - 必须在用户故事之前完成）
- **阶段3+**：按优先级顺序的用户故事（P1，P2，P3...）
  - 在每个故事内：测试（如有请求）→模型→服务→端点→集成
  - 每个阶段应该是一个完整的、可独立测试的增量
- **最后阶段**：完善与跨领域关注点